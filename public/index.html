<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Wolk</title>
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/skeleton.css">
  <link rel="stylesheet" href="css/wolk.css">
  <script src="js/reconnecting-websocket.min.js" charset="utf-8"></script>
  <script src="js/draggabilly.pkgd.min.js"></script>
  <script src="js/d3.min.js"></script>
  <script src="js/wolk-client.js"></script>
  <link rel="icon" type="image/png" href="images/favicon.png">
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="one-half column">
        <img src="img/wolk.svg" width="60%"/>
        <h4>Wolk</h4>
        <p>
          <button id="go">Invert</button>
        </p>
        <p>
          <button id="bpm">BPM</button>
        </p>
      </div>

      <div id="patterns">
      </div>

    </div>
  </div>


  <script>
    function onDragMove(event, pointer, moveVector) {
      var data = d3.select(this.element).datum();
      var p = this.position.x / (this.element.parentElement.offsetWidth - this.element.offsetWidth);
      p = Math.round(p * 100) / 100;

      if (p <= 0.03) {
        p = 0;
      } else if (p >= 0.97) {
        p = 1;
      }

      wolkSend('set-function', {
        name: data.name,
        value: p
      });
    }

    function onDragEnd(event, pointer) {
      // console.log(onDragEnd)
      // console.log(this.element.id)
    }

    function onStaticClick(event, pointer) {
      // console.log(onDragEnd)
      // console.log(this.element.id)
    }

    d3.json('patterns', function(patterns) {
      d3.select('#patterns').selectAll('.drag')
          .data(patterns)
        .enter()
          .append('div')
          .attr('class', 'drag')
          .html(function(d) {
            return d.title;
          })
          .each(function(d) {
            var draggie = new Draggabilly(this, {
              axis: 'x',
              containment: '#patterns'
            });

            draggie.on('dragMove', onDragMove);
            draggie.on('dragEnd', onDragEnd);
            draggie.on('staticClick', onStaticClick);
          });
    });




  </script>
  <script>
    var inverted = false;
    d3.select('#go').on('click', function() {
      inverted = !inverted;
      wolkSend('invert', inverted);
    });

    // BPM
    var bpmTimeout;
    var beats = [];
    var firstMs;
    var oldMs;
    d3.select('#bpm').on('click', function() {
      var ms = new Date().getTime();

      if (bpmTimeout) {
        clearTimeout(bpmTimeout);
      }

      bpmTimeout = setTimeout(function() {
        beats = [];
        firstMs = undefined;
        oldMs = undefined;
      }, 2000);

      if (!firstMs) {
        firstMs = ms;
      }

      if (oldMs) {
        var duration = ms - oldMs;
        beats.push(duration);
      }

      if (beats.length >= 4) {
        var sum = beats.reduce(function(d1, d2) { return d1 + d2; });
        var avgDuration = sum / beats.length;

        wolkSend('bpm', {
          start: firstMs,
          bpm: Math.round(60 * 1000 / avgDuration)
        });
      }

      oldMs = ms;
    });



  </script>
</body>
</html>
